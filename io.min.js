// JS Library for data collection. Apache License.
// https://github.com/lyticsio/jstag
(function(e,t,n){function c(e,t){return l.call(e)==="[object "+t+"]"}function h(e){return c(e,"Function")}function d(e){return c(e,"Object")}function v(e){return c(e,"String")}function m(e){return c(e,"Array")}function g(e,t,n){if(!t)return e;for(p in t)t.hasOwnProperty(p)&&(!(p in e)||n)&&(e[p]=t[p]);return e}function y(e,t){return g(o.config,e,!0),o}function E(e,t,n){t.opts=g(n?n:{},n),e in b?b[e].push(t):b[e]=[t]}function S(e){var t=[],n=Array.prototype.slice.call(arguments,1);if(b[e]&&b[e][u])for(var r=0,i=b[e][u];r<i;r++)if(h(b[e][r])){var s=b[e][r];s.opts.onetime?t.push(s):s.apply({},n)}t[u]>0&&b[e]&&(b[e]=b[e].filter(function(e,n,r){return t.indexOf(e)==-1})),t.forEach(function(e){e.apply({},n)})}function x(){"_q"in o&&m(o._q)&&o._q.forEach(function(e){v(e[1])&&e[1]in o?E(e[0],function(){o[e[1]].apply(o,f.call(e[2]))}):E.apply(o,[e[0]].concat(f.call(e[1])))})}function T(e){if(i[u]>0){var t=i.indexOf(e+"=");if(t!=-1)return t+=e.length+1,end=i.indexOf(";",t),end==-1&&(end=i[u]),unescape(i.substring(t,end))}return null}function N(e){t.cookie=e+"=; path=/; expires=Monday, 19-Aug-1996 05:00:00 GMT"}function C(e,n,r,i,s,o){var u=e+"="+escape(n)+(r?"; expires="+r.toGMTString():"")+(i?"; path="+i:"")+(s?"; domain="+s:"")+(o?"; secure":"");t.cookie=u}function k(e,t,n){return e.indexOf("?")<1?e+="?":e+="&",e+t+"="+n}function A(e){return encodeURIComponent(e)}function O(e,t){var n=[],r="";arguments.length==1&&(t="");for(p in e)r=p,t!=""&&(r=t+"."+p),d(e[p])?n.push(O(e[p],p)):h(e[p])?n.push(r+"="+e[p]()):m(e[p])?n.push(r+"=["+e[p].join(",")+"]"):n.push(r+"="+A(e[p]));return n.join("&")}function M(e){return this instanceof M?(this.init(e),this):new M(e)}function _(e,t){if("io"in a)a.io.forEach(function(n){n.send(e,t)});else{var n=new M;n.send(e,t)}}function D(e,t){var n="";t=t||"";for(p in e)d(e[p])?n+=D(e[p],p+"."):n+="<tr><td>"+t+p+"</td><td>"+e[p]+"</td></tr>";return n}var r=t.location,i=t.cookie,s=t.referrer,o=e.jstag||{},u="length",a={},f=Array.prototype.slice,l=Object.prototype.toString;e.jstag=o,e.console||(e.console={log:function(){}}),o.config={url:"",Q:[],id:undefined,cid:undefined,serializer:O,pipeline:["identity","analyze"],delay:200,cookie:"seerid",sesname:"seerses",sessecs:1800,channel:"Form"},"_c"in o&&y(o._c),o.init=o.connect=y;var b={},w={onetime:!1};o.bind=E,o.emit=S,o.channels={Gif:function(n){return this instanceof Gif?{images:[],send:function(n,r){if(t.images){var i=this,s=new Image,o=function(){r.callback.hasRun||(r.callback.hasRun=!0,r.callback(r))};this.images.push(s),arguments.length===2&&r&&h(r.callback)&&(r.callback.hasRun=!1,s.onload=o(),e.setTimeout(o,M.config.delay)),s.src=this.getUrl()}},getUrl:function(){}}:new Gif(n)},Form:function(e){this.config=e;var n=this;return{send:function(n,r){var i=t.createElement("iframe"),s,o;t.body.appendChild(i),i.style.display="none",setTimeout(function(){s=i.contentWindow.document.createElement("form"),i.contentWindow.document.body.appendChild(s),s.setAttribute("action",e.url),s.setAttribute("method","post"),o=i.contentWindow.document.createElement("input"),o.setAttribute("type","hidden"),o.setAttribute("name","_js"),o.value=n,s.appendChild(o),s.submit(),r&&h(r.callback)&&r.callback(r),setTimeout(function(){t.body.removeChild(i)},2e3)},0)}}}};var L={analyze:function(e){e.data._e="pv";var t=T(o.config.sesname),n=undefined;if(!t){var i=new Date;i.setTime(i.getTime()+o.config.sessecs*1e3),C(o.config.sesname,"e",i),e.data._sesstart="1"}if(!("_ref"in e.data)&&s&&s[u]>1){var a=s.toString().match(/\/\/(.*)\//);a&&a[1].indexOf(r.host)==-1&&(e.data._ref=s.replace("http://","").replace("https://",""),t||(e.data._sesref=s.replace("http://","").replace("https://","")))}"url"in e.data||(e.data.url=r.href.replace("http://","").replace("https://",""))},identity:function(e){if(!("_uid"in e.data)){var t="seerid",n;e.config&&e.config.cookie&&(t=e.config.cookie),n=T(t),e.config.url=k(e.config.url,"_uidn",t),n&&n[u]&&(e.data._uid=n)}}};L.analyze.onetime=!0,o.Io=M,o.send=_,M.prototype=function(){var t=[],n=null,r=null;return{init:function(i){n=this,r=g(i?i:{},o.config);if(!o.config.url||!o.config.cid)throw new Error("Must have collection url and Account");"cid"in r&&!o.config.cid&&(o.config.cid=r.cid),r.url=o.config.url+"/c/"+o.config.cid,r.stream&&(r.url+="/"+r.stream),this.config=r,this.serializer=r.serializer,"io"in a?a.io.push(this):a.io=[this],this.channel=new o.channels[r.channel](r),r.pipeline.forEach(function(n){h(n)?t.push(n):n in L?t.push(L[n]):n in e&&t.push(e[n])});if(r.Q&&r.length>0){var s=0,u=Q.length;r.Q.forEach(function(e){n.send.apply(n,e)})}r.Q&&(r.Q.push=function(){n.send.apply(n,Array.prototype.slice.call(arguments))}),o.emit("io.ready",this)},send:function(e,n){e=e?e:{},this.data=e,e._ts=(new Date).getTime();var r={data:e,callback:n,config:this.config},i=this;t.forEach(function(e){e(r)}),t=t.filter(function(e){return!e.onetime}),o.emit("send.before",r),this.channel.send(this.serializer(r.data),{callback:function(){h(n)&&n(r,i),o.emit("send.finished",r,i)}})},debug:function(){return"<table><tr><th>field</th><th>value</th></tr>"+D(this.data)+"</table>"}}}(),e&&"AsyncInit"in e&&h(e.AsyncInit)&&e.AsyncInit(),"ready"in o||(o.ready=function(){}),o.load=function(){return this},x(),o.emit("ready")})(window,document);